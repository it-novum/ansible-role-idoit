- set_fact:
    php_hell: "70"
  when: ansible_distribution_release == "xenial" or ansible_distribution_release == "stretch" or ansible_distribution_release == "jessie"

- set_fact:
    php_hell: "72"
  when: ansible_distribution_release == "bionic"

- name: Switch to MySQL vendor from system on Ubuntu 14 and Debian 8
  set_fact: mysql_type=vendor
  when: >
    mysql_type == "system" and
    (
      ansible_distribution_release == "trusty" or
      ansible_distribution_release == "jessie"
    )

- set_fact: 
    apt_dependencies:
      - php-memcache
      - memcached
      - php7.0-snmp
      - php7.0-zip
      - php7.0-bcmath
  when: php_hell == "70"

- set_fact: 
    apt_dependencies:
      - php-memcache
      - memcached
      - php-snmp
      - php-zip
      - php-bcmath
  when: php_hell == "72"

- set_fact: 
    php_fpm_service_name: "php7.0-fpm"
  when: php_hell == "70"

- set_fact: 
    php_fpm_service_name: "php7.2-fpm"
  when: php_hell == "72"


- name: MySQL
  include_role: name=mysql

- name: Apache
  include_role: name=apache

- name: Vhost
  include_role: name=vhost
  vars:
    use_php: true

- name: APT | Install dependencies
  apt:
    name: "{{ apt_dependencies }}"

- name: Fact | createdb
  set_fact: "{{item.key}}={{item.value}}"
  with_items:
    - key: "createdb_dbs"
      value: "mysql"
    - key: "createdb_config"
      value: "{{ vhost_directory }}/.my.cnf"
    - key: "createdb_user"
      value: "{{ idoit_database_user }}"
    - key: "createdb_host"
      value: "127.0.0.1"

- name: System Database
  include_role: name=createdb
  vars:
    createdb_database: "{{ idoit_database_system }}"

- name: Data Database
  include_role: name=createdb
  vars:
    createdb_database: "{{ idoit_database_data }}"

- name: restart service
  service:
   name: "{{ item }}"
   state: restarted
  with_items:
    - mysql
    - apache2
    - "{{ php_fpm_service_name }}"

- name: Check idoit instance
  stat:
    path: "{{ vhost_directory }}/htdocs/setup/install.sh"
  register: idoit_install_sh

- name: Check idoit configuration
  stat:
    path: "{{ vhost_directory }}/htdocs/src/config.inc.php"
  register: idoit_config_inc

- name: check if idoit installation archive exists
  local_action: stat path={{idoit_zip_file}}
  register: idoit_local_zip_stat

- fail:
    msg: "idoit isn't installed and installation archive not found"
  when: not idoit_install_sh.stat.exists and not idoit_local_zip_stat.stat.exists

- name: Extract idoit
  unarchive:
    src: "{{ idoit_zip_file }}"
    dest: "{{vhost_directory}}/htdocs"
  when: not idoit_install_sh.stat.exists

- block:
  - name: Import system database
    mysql_db:
      name: "{{ idoit_database_system }}"
      encoding: "utf8"
      state: "import"
      target: "{{ vhost_directory }}/htdocs/setup/sql/idoit_system.sql"

  - name: Import data database
    mysql_db:
      name: "{{ idoit_database_data }}"
      encoding: "utf8"
      state: "import"
      target: "{{ vhost_directory }}/htdocs/setup/sql/idoit_data.sql"

  - name: Create default mandator sql
    copy:
      dest: "/root/.ansible/mandator.sql"
      content: "REPLACE INTO isys_mandator VALUES (1, '{{ idoit_default_mandator }}', '{{ idoit_default_mandator }}', 'cache_{{ idoit_default_mandator }}', 'default', '127.0.0.1', '3306', '{{ idoit_database_data }}', '{{ createdb_user }}', '{{ createdb_password }}', '', '1', '1');"

  - name: Create default mandator
    mysql_db:
      name: "{{ idoit_database_system }}"
      encoding: "utf8"
      state: "import"
      target: "/root/.ansible/mandator.sql"

  - name: Delete default mandator sql
    file:
      state: "absent"
      path: "/root/.ansible/mandator.sql"

  - name: Copy configuration template
    copy:
      src: "{{ vhost_directory }}/htdocs/setup/config_template.inc.php"
      dest: "{{ vhost_directory }}/htdocs/src/config.inc.php"
      owner: "{{ vhost_user }}"
      group: "{{ vhost_user }}"
      mode: 0644
      remote_src: true
  
  - name: Generate Random Admin password
    shell: < /dev/urandom tr -dc "_A-Z-a-z-0-9\+\-:." | head -c18
    register: random_output

  - name: Apply configuration
    replace: dest={{ vhost_directory }}/htdocs/src/config.inc.php regexp={{ item.regexp }} replace={{ item.replace }}
    with_items:
      - regexp: "%config.adminauth.username%"
        replace: admin
      - regexp: "%config.adminauth.password%"
        replace: "{{random_output.stdout}}"
      - regexp: "%config.db.host%"
        replace: 127.0.0.1
      - regexp: "%config.db.port%"
        replace: 3306
      - regexp: "%config.db.username%"
        replace: "{{ createdb_user }}"
      - regexp: "%config.db.password%"
        replace: "{{ createdb_password }}"
      - regexp: "%config.db.name%"
        replace: "{{ idoit_database_system }}"
  when: not idoit_config_inc.stat.exists

- name: Set permissions
  tree_permission:
    root_path: "{{ vhost_directory }}/htdocs"
    regexp:
      - paths:
          - ".*"
        file_mode: "0644"
        dir_mode: "0755"
        file_owner: "{{ vhost_user }}"
        file_group: "{{ vhost_user }}"
        dir_owner: "{{ vhost_user }}"
        dir_group: "{{ vhost_user }}"
      - paths:
          - "/"
        dir_mode: "0750"
        dir_owner: "{{ vhost_user }}"
        dir_group: "{{ vhost_user }}"
      - paths:
          - "/checkmk_transfer.sh"
          - "/controller"
          - "/idoit-rights.sh"
          - "/import"
          - "/tenants"
          - "/updatecheck"
        file_mode: "0755"
        file_owner: "{{ vhost_user }}"
        file_group: "{{ vhost_user }}"

- name: idoit command
  template:
    src: idoit.j2
    dest: /usr/local/bin/idoit
    owner: root
    group: root
    mode: 0755

# Only root has access to this command, because it stores credentials
- name: idoit-jobs command
  template:
    src: idoit-jobs.j2
    dest: /usr/local/bin/idoit-jobs
    owner: root
    group: root
    mode: 0700

# Only root has access to this file, because it stores credentials
- name: idoit-jobs default config
  copy:
    src: idoit-jobs-etc
    dest: /etc/default/idoit-jobs
    owner: root
    group: root
    mode: 0600
    force: no

- name: idoit-jobs cronjob
  cron:
    name: "idoit cache cleanup"
    cron_file: "idoit"
    user: "root"
    minute: "0"
    hour: "1"
    job: "/usr/local/bin/idoit-jobs"

- debug:
    msg: "Idoit admin backend password: {{random_output.stdout}}"
  when: random_output.stdout is defined
